<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""></script>
    <link rel="icon" href="data:,">
    <style type="text/css">
      html { height: 100% }
      body { height: 100%;
             margin: 0;
             padding: 0;
             overflow: hidden; /* new for only vertical scrolling of TII-Info at right side */
      }
      .transmitter-icon
      {
        padding:0px;
        margin:0px;
        color:black;
        border:2px solid rgba(0,0,0,1);
        text-align:center;
      }
      #map { height: 100% }
      #info
      {
        position:absolute;
        overflow-y:auto; /* new for only vertical scrolling of TII-Info at right side */
        width:20%;
        height:100%;
        bottom:0px;
        right:0px;
        top:0px;
        background-color: white;
        border-left:1px #666 solid;
        font-family:Helvetica;
      }
      #info div
      {
        padding:0px;
        padding-left:10px;
        margin:0px;
      }
      #info div h1
      {
        margin-top:10px;
        font-size:16px;
      }
      #info div p
      {
        font-size:14px;
        color:#333;
      }
      .coloring
      {
        color: red
      }
    </style>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script type="text/javascript">
      let Map = null;
      let homeLatitude = $;
      let homeLongitude = $;
      let Transmitters = {};
      let transmitterIndex = 0;
      let transmitterIndexMaxForZoom = 0;
      let suppressAutoFrame = false;
      let isAutoFramingNow = false;
      let pollTimerId = null;
      let consecutivePollErrors = 0;
      let MAX_POLL_ERRORS = 3;

      const MAP_RESET = 0;
      const MAP_FRAME = 1;
      const MAP_MAX_TRANS = 2;
      const MAP_NORM_TRANS = 4;
      const MAP_CLOSE = 5;

      function getIconForHome()
      {
        let he = document.createElement("P");
        he.innerHTML = '*';
        he = '<div style="font-size:1rem">&#x2B55</div>';
        let icon = L.divIcon({html: he, className: 'home-icon'});
        return icon;
      }

      function getIconForTransmitter(target)
      {
        let tii = target.mainId + '-' + target.subId;

        // Linear interpolation: alpha = 1.0 at -6, 0.20 at -30
        // Formula: alpha = 1.0 - (strength - (-6)) * (1.0 - 0.20) / (-30 - (-6))
        let alpha = 1.0 - (target.strength - (-6.0)) * 0.80 / (-24.0);

        if (alpha > 1.0) alpha = 1.0;
        if (alpha < 0.2) alpha = 0.2;

        let he = '<div style="background:rgba(255,0,0,' + alpha.toFixed(2) + ');">';
        he += '<b>' + tii + '</b>' + '</div>';
        return L.divIcon({iconSize: [tii.length * 6.5, 18], html: he, className: 'transmitter-icon'});
      }

      function handle_map_reset()
      {
        for (let i = 0; i < transmitterIndex; i ++)
        {
          Map.removeLayer(Transmitters[i].marker);
          delete Transmitters[i];
        }
        Transmitters = {};
        transmitterIndex = 0;
        let xx = document.getElementById('selinfo');
        xx.innerHTML = '';
        let yy = document.getElementById('selCount');
        yy.innerHTML = '';
      }
      function getSideBarTransmitterString(target)
      {
         return target.name + ' (' + target.power.toFixed(2) + ' kW)' + '<br>' +
                'Altitude ' + target.altitude + 'm, Height ' + target.height + 'm' + '<br>' +
                'Latitude ' + target.lat.toFixed(4) + '&#xb0' + ', Longitude ' + target.lon.toFixed(4) + '&#xb0' + '<br>' +
                'Polarization ' + target.pol.toUpperCase() + ', Direction ' + target.dir + '<br>' +
                'TII ' + target.mainId + '-' + target.subId + target.nonetsi +
                ', Level ' + target.strength.toFixed(1) + 'dB' + '<br>' +
                'Distance from home ' + target.dist.toFixed(1) + 'km ' + target.azimuth.toFixed(1) + '&#xb0';
      }

      function showTransmitterAtSideBar(target)
      {
        let xx = document.getElementById('selinfo');
        xx.innerHTML += getSideBarTransmitterString(target) + '<br><br>';

        let yy = document.getElementById('selCount');
        yy.innerHTML = '<span style=\"font-weight:bold;">' + 'Number of transmitters: ' + transmitterIndex + '<br>' +
                       'Channel: ' + target.channel + '<br>' + '</span>';
      }

      function selectTransmitterCallback(target)
      {
        let zz = document.getElementById('selected');
        zz.innerHTML = '<p style=\"padding: 10px; border:2px solid black;\">' + 'Selected:  ' + '<br>' +
                       getSideBarTransmitterString(target) + '<br></p>'
      }

      function addTransmitter(target)
      {
        let icon = getIconForTransmitter(target);
        let tooltip = target.name + ' ' + target.dist.toFixed(1) + 'km'
        let marker = L.marker([target.lat, target.lon], {icon: icon, title: tooltip}).addTo(Map);
        target.marker = marker;
        target.marker.addEventListener('click', function() { selectTransmitterCallback(target);});
        Transmitters[transmitterIndex] = target;
        transmitterIndex++;
        showTransmitterAtSideBar(target);
      }

      function attemptClose(reason)
      {
        try { if (pollTimerId) { window.clearInterval(pollTimerId); } } catch(e) {}
        // Best-effort close (works for Qt WebEngine or when window was script-opened)
        try { window.close(); } catch(e) {}
        try { self.close(); } catch(e) {}
        // If still not closed (e.g., in a regular browser tab), replace UI with a notice
        setTimeout(function(){
          try {
            document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;width:100%;height:100%;font-family:Helvetica,Arial,sans-serif;">' +
              '<div style="text-align:center">' +
              '<h2 style="margin:0 0 8px 0;">Server not available</h2>' +
              '<p style="margin:0;color:#555">' + (reason ? reason : 'The DABstar server appears to be closed.') + '</p>' +
              '<p style="margin-top:12px;color:#777">You can close this window.</p>' +
              '</div>' +
            '</div>';
          } catch(e) {}
        }, 50);
      }

      function fetchData()
      {
        $.getJSON('/data.json')
        .done(function(data)
        {
          consecutivePollErrors = 0;
          handle_map_reset();
          for (let t = 0; t < data.length; t ++)
          {
            let target = data[t];

            if (target.type === MAP_NORM_TRANS)
            {
              addTransmitter(target);
            }
            else if (target.type === MAP_RESET)
            {
              let zz = document.getElementById('selected');
              zz.innerHTML = '';
              transmitterIndexMaxForZoom = 0;
              suppressAutoFrame = false;
            }
            else if (target.type === MAP_CLOSE)
            {
              // Immediate close requested by backend
              attemptClose('Server requested to close the map window.');
              return; // stop processing
            }
          }

          if (!suppressAutoFrame && transmitterIndex > 0 && transmitterIndexMaxForZoom < transmitterIndex)
          {
            let bounds = L.latLngBounds([]);
            let minDistKm = Infinity;
            for (let i = 0; i < transmitterIndex; i++)
            {
              bounds.extend([Transmitters[i].lat, Transmitters[i].lon]);
              let d = parseFloat(Transmitters[i].dist);
              if (isFinite(d) && d < minDistKm) minDistKm = d;
            }
            if (isFinite(minDistKm) && minDistKm < 200) // add home to zoom range if below 200km
            {
              bounds.extend([homeLatitude, homeLongitude]);
            }
            if (bounds.isValid())
            {
              transmitterIndexMaxForZoom = transmitterIndex
              isAutoFramingNow = true;
              Map.once('moveend', function(){ isAutoFramingNow = false; });
              Map.fitBounds(bounds, {padding: [20, 20]});
            }
          }
        })
        .fail(function(jqXHR, textStatus, errorThrown)
        {
          consecutivePollErrors++;
          if (consecutivePollErrors >= MAX_POLL_ERRORS)
          {
            attemptClose('Lost connection to server.');
          }
        });
      }

      function initialize()
      {
        Map = L.map('map').setView([homeLatitude, homeLongitude], 8);

        Map.on('zoomstart', function(){ if (!isAutoFramingNow) suppressAutoFrame = true; });
        Map.on('movestart', function(){ if (!isAutoFramingNow) suppressAutoFrame = true; });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
        {
          attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
          maxZoom: 18
        }).addTo(Map);

        let icon = getIconForHome();
        let homeMarker = L.marker([homeLatitude, homeLongitude], {icon: icon}).addTo(Map);

        // Setup our timer to poll from the server.
        pollTimerId = window.setInterval(function()
        {
          fetchData();
        }, 2000);
      }

    </script>
  </head>

  <body onload="initialize()">
    <div id="map" style="width:80%; height:100%"></div>
    <div id="info">
      <div>
        <h1>DABstar</h1>
        <p id="selected"></p>
        <p id="selCount"></p>
        <p id="selinfo"></p>
     </div>
    </div>
  </body>
</html>
